<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û–±–ª—ñ–∫ –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- SheetJS –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --primary: #2e86de;
      --background: #f1f2f6;
      --card: #ffffffcc;
      --accent: #dcdde1;
      --text: #2f3640;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #dff9fb, #f6e58d);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    header h1 {
      margin: 0;
      font-size: 28px;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    nav button {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    nav button.active,
    nav button:hover {
      background: var(--primary);
      color: white;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
    }

    .card {
      background-color: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
    }

    select,
    input {
      padding: 10px;
      width: 100%;
      max-width: 300px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      padding: 10px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 16px;
      transition: background 0.2s;
    }

    .btn:hover {
      background-color: #1b4f9c;
    }

    #report-output {
      background: var(--accent);
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .hidden {
      display: none;
    }

    ul {
      padding-left: 20px;
    }

    li {
      margin-bottom: 5px;
    }

    li button {
      margin-left: 5px;
      font-size: 14px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>–û–±–ª—ñ–∫ –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó</h1>
    <p>–ë—É–¥–∏–Ω–æ–∫: –ø—Ä–æ–≤. –≥–µ–Ω–µ—Ä–∞–ª–∞ –í–∏—à–Ω–µ–≤—Å—å–∫–æ–≥–æ 13/1</p>
    <nav>
      <button onclick="showSection('flats')" id="btn-flats" class="active">–ö–≤–∞—Ä—Ç–∏—Ä–∏</button>
      <button onclick="showSection('report')" id="btn-report">–ó–≤—ñ—Ç</button>
    </nav>
  </header>

  <div class="container">
    <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∏ -->
    <div class="card" id="section-flats">
      <h2>–í–∏–±—ñ—Ä –∫–≤–∞—Ä—Ç–∏—Ä–∏</h2>
      <select id="flat-select" onchange="showFlatForm()">
        <option value="">‚Äî –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É ‚Äî</option>
      </select>

      <div id="flat-form" class="form-group hidden">
        <label for="flat-month">–ú—ñ—Å—è—Ü—å</label>
        <input type="month" id="flat-month" />

        <label for="flat-value">–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è (–∫–í—Ç¬∑–≥)</label>
        <input type="number" id="flat-value" placeholder="0" />

        <button class="btn" onclick="saveConsumption()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>

        <hr />
        <h3>–í–Ω–µ—Å–µ–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏:</h3>
        <div id="existing-data"></div>
      </div>
    </div>

    <!-- –ó–≤—ñ—Ç -->
    <div class="card hidden" id="section-report">
      <h2>–ó–≤—ñ—Ç –∑–∞ –ø–µ—Ä—ñ–æ–¥</h2>
      <div class="form-group">
        <label>–ó:</label>
        <input type="month" id="from" />
        <label>–î–æ:</label>
        <input type="month" id="to" />
        <button class="btn" onclick="generateReport()">üìä –ü–æ–∫–∞–∑–∞—Ç–∏ –∑–≤—ñ—Ç</button>
        <button class="btn" onclick="exportToExcel()">üì• –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —É Excel</button>
      </div>
      <div id="report-output"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'electricity_data';
    let flats = [];

    function initData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        flats = JSON.parse(saved);
      } else {
        flats = Array.from({ length: 300 }, (_, i) => ({
          number: i + 1,
          consumption: {}
        }));
        saveData();
      }

      const select = document.getElementById('flat-select');
      flats.forEach(flat => {
        const opt = document.createElement('option');
        opt.value = flat.number;
        opt.textContent = `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ${flat.number}`;
        select.appendChild(opt);
      });
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(flats));
    }

    function showFlatForm() {
      const selected = document.getElementById('flat-select').value;
      const form = document.getElementById('flat-form');
      const dataBlock = document.getElementById('existing-data');
      if (!selected) {
        form.classList.add('hidden');
        return;
      }

      form.classList.remove('hidden');
      const flat = flats.find(f => f.number === parseInt(selected));
      const entries = Object.entries(flat.consumption);
      if (entries.length === 0) {
        dataBlock.innerHTML = '<i>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö.</i>';
        return;
      }

      let html = '<ul>';
      entries.sort().forEach(([month, value]) => {
        html += `
          <li>
            <b>${month}</b>: ${value} –∫–í—Ç¬∑–≥
            <button onclick="editEntry(${flat.number}, '${month}')">‚úèÔ∏è</button>
            <button onclick="deleteEntry(${flat.number}, '${month}')">üóëÔ∏è</button>
          </li>`;
      });
      html += '</ul>';
      dataBlock.innerHTML = html;
    }

    function saveConsumption() {
      const flatNum = parseInt(document.getElementById('flat-select').value);
      const month = document.getElementById('flat-month').value;
      const value = parseFloat(document.getElementById('flat-value').value);
      if (!flatNum || !month || isNaN(value)) {
        alert("‚ùó –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è.");
        return;
      }
      const flat = flats.find(f => f.number === flatNum);
      flat.consumption[month] = value;
      saveData();
      alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ: –∫–≤. ‚Ññ${flatNum}, ${month} ‚Äî ${value} –∫–í—Ç¬∑–≥`);
      document.getElementById('flat-month').value = '';
      document.getElementById('flat-value').value = '';
      showFlatForm();
    }

    function editEntry(flatNum, month) {
      const flat = flats.find(f => f.number === flatNum);
      const value = flat.consumption[month];
      document.getElementById('flat-month').value = month;
      document.getElementById('flat-value').value = value;
    }

    function deleteEntry(flatNum, month) {
      if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å –∑–∞ ${month}?`)) return;
      const flat = flats.find(f => f.number === flatNum);
      delete flat.consumption[month];
      saveData();
      showFlatForm();
    }

    function generateReport() {
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const tariff = 4.32;
      if (!from || !to || from > to) {
        alert("‚ùó –í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.");
        return;
      }

      let output = '';
      let grandTotal = 0;
      flats.forEach(flat => {
        const totalKWh = Object.entries(flat.consumption)
          .filter(([date]) => date >= from && date <= to)
          .reduce((sum, [, value]) => sum + value, 0);
        if (totalKWh > 0) {
          const sum = totalKWh * tariff;
          grandTotal += sum;
          output += `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ${flat.number}: ${totalKWh.toFixed(2)} –∫–í—Ç¬∑–≥ ‚Üí ${sum.toFixed(2)} –≥—Ä–Ω\n`;
        }
      });

      if (output === '') {
        output = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.';
      } else {
        output += `\nüî∑ –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –¥–æ –æ–ø–ª–∞—Ç–∏ –ø–æ –±—É–¥–∏–Ω–∫—É: ${grandTotal.toFixed(2)} –≥—Ä–Ω`;
      }

      document.getElementById('report-output').textContent = output;
    }

    function exportToExcel() {
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const tariff = 4.32;

      if (!from || !to || from > to) {
        alert("‚ùó –í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.");
        return;
      }

      const rows = [["–ö–≤–∞—Ä—Ç–∏—Ä–∞", "–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è (–∫–í—Ç¬∑–≥)", "–°—É–º–∞ (–≥—Ä–Ω)"]];
      let grandTotal = 0;

      flats.forEach(flat => {
        const totalKWh = Object.entries(flat.consumption)
          .filter(([date]) => date >= from && date <= to)
          .reduce((sum, [, value]) => sum + value, 0);

        if (totalKWh > 0) {
          const sum = totalKWh * tariff;
          grandTotal += sum;
          rows.push([`‚Ññ${flat.number}`, totalKWh.toFixed(2), sum.toFixed(2)]);
        }
      });

      if (rows.length === 1) {
        alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.");
        return;
      }

      rows.push(["–ó–∞–≥–∞–ª–æ–º", "", grandTotal.toFixed(2)]);

      const worksheet = XLSX.utils.aoa_to_sheet(rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "–ó–≤—ñ—Ç");

      XLSX.writeFile(workbook, `–ó–≤—ñ—Ç_–µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è_${from}_–¥–æ_${to}.xlsx`);
    }

    function showSection(name) {
      document.getElementById('section-flats').classList.add('hidden');
      document.getElementById('section-report').classList.add('hidden');
      document.getElementById(`section-${name}`).classList.remove('hidden');

      document.getElementById('btn-flats').classList.remove('active');
      document.getElementById('btn-report').classList.remove('active');
      document.getElementById(`btn-${name}`).classList.add('active');
    }

    initData();
  </script>

</body>
</html>
